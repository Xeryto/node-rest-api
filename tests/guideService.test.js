let guideService = require('../src/services/guideService');
const chai = require('chai');
expect = chai.expect;
const {stub, restore} = require("sinon");
const {Model} = require("mongoose");
const rewire = require("rewire");
chai.use(require('chai-as-promised'));

describe('Test guideService', () => {
    afterEach(() => {
        guideService = rewire('../src/services/guideService');
        restore();
    });

    describe('Test getCountryInfo', async () => {
        let sampleCachedResponse;
        let findOneStub;
        let createStub;

        beforeEach(() => {
            sampleCachedResponse = null;

            findOneStub = stub(Model, 'findOne').resolves(sampleCachedResponse);
            createStub = stub(Model, 'create').resolves(sampleCachedResponse);
        });

        it('When both a country and a currency are provided, it should return the result based on the country name', async () => {
            const result = JSON.stringify(await guideService.getCountryInfo('United States of America', 'RUB'));
            const expected = JSON.stringify(JSON.parse('[{"name": {"common": "United States", "official": "United States of America", "nativeName": {"eng": {"official": "United States of America", "common": "United States"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["CAN", "MEX"], "flag": "\uD83C\uDDFA\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/e8M246zY4BSjkjAv6", "openStreetMaps": "https://www.openstreetmap.org/relation/148838#map=2/20.6/-85.8"}}]'));
            expect(result).to.equal(expected);
        });

        it('When only provided with currency, should return a list of all countries that use that currency', async () => {
            const result = JSON.stringify(await guideService.getCountryInfo(undefined,'USD'));
            const expected = JSON.stringify(JSON.parse('[{"name": {"common": "United States Minor Outlying Islands", "official": "United States Minor Outlying Islands", "nativeName": {"eng": {"official": "United States Minor Outlying Islands", "common": "United States Minor Outlying Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFA\uD83C\uDDF2", "maps": {"googleMaps": "https://goo.gl/maps/hZKnrzgeK69dDyPF8", "openStreetMaps": "https://www.openstreetmap.org/relation/6430384"}}, {"name": {"common": "Turks and Caicos Islands", "official": "Turks and Caicos Islands", "nativeName": {"eng": {"official": "Turks and Caicos Islands", "common": "Turks and Caicos Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF9\uD83C\uDDE8", "maps": {"googleMaps": "https://goo.gl/maps/R8VUDQfwZiFtvmyn8", "openStreetMaps": "https://www.openstreetmap.org/relation/547479"}}, {"name": {"common": "Puerto Rico", "official": "Commonwealth of Puerto Rico", "nativeName": {"eng": {"official": "Commonwealth of Puerto Rico", "common": "Puerto Rico"}, "spa": {"official": "Estado Libre Asociado de Puerto Rico", "common": "Puerto Rico"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF5\uD83C\uDDF7", "maps": {"googleMaps": "https://goo.gl/maps/sygfDbtwn389wu8x5", "openStreetMaps": "https://www.openstreetmap.org/relation/4422604"}}, {"name": {"common": "British Virgin Islands", "official": "Virgin Islands", "nativeName": {"eng": {"official": "Virgin Islands", "common": "British Virgin Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFB\uD83C\uDDEC", "maps": {"googleMaps": "https://goo.gl/maps/49C9cSesNVAR9DQk8", "openStreetMaps": "https://www.openstreetmap.org/relation/285454"}}, {"name": {"common": "Ecuador", "official": "Republic of Ecuador", "nativeName": {"spa": {"official": "República del Ecuador", "common": "Ecuador"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["COL", "PER"], "flag": "\uD83C\uDDEA\uD83C\uDDE8", "maps": {"googleMaps": "https://goo.gl/maps/TbX8hUW4gcbRPZiK7", "openStreetMaps": "https://www.openstreetmap.org/relation/108089"}}, {"name": {"common": "Caribbean Netherlands", "official": "Bonaire, Sint Eustatius and Saba", "nativeName": {"nld": {"official": "Bonaire, Sint Eustatius en Saba", "common": "Caribisch Nederland"}, "pap": {"official": "Boneiru, Sint Eustatius y Saba", "common": "Boneiru, Sint Eustatius y Saba"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE7\uD83C\uDDF6", "maps": {"googleMaps": "https://goo.gl/maps/4XVes1P6uEDTz77WA", "openStreetMaps": "https://www.openstreetmap.org/relation/1216720"}}, {"name": {"common": "Cambodia", "official": "Kingdom of Cambodia", "nativeName": {"khm": {"official": "ព្រះរាជាណាចក្រកម្ពុជា", "common": "Kâmpŭchéa"}}}, "currencies": {"KHR": {"name": "Cambodian riel", "symbol": "៛"}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["LAO", "THA", "VNM"], "flag": "\uD83C\uDDF0\uD83C\uDDED", "maps": {"googleMaps": "https://goo.gl/maps/nztQtFSrUXZymJaW8", "openStreetMaps": "https://www.openstreetmap.org/relation/49898"}}, {"name": {"common": "Guam", "official": "Guam", "nativeName": {"cha": {"official": "Guåhån", "common": "Guåhån"}, "eng": {"official": "Guam", "common": "Guam"}, "spa": {"official": "Guam", "common": "Guam"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEC\uD83C\uDDFA", "maps": {"googleMaps": "https://goo.gl/maps/Xfnq2i279b18cH3C9", "openStreetMaps": "https://www.openstreetmap.org/relation/306001"}}, {"name": {"common": "United States Virgin Islands", "official": "Virgin Islands of the United States", "nativeName": {"eng": {"official": "Virgin Islands of the United States", "common": "United States Virgin Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFB\uD83C\uDDEE", "maps": {"googleMaps": "https://goo.gl/maps/mBfreywj8dor6q4m9", "openStreetMaps": "openstreetmap.org/relation/286898"}}, {"name": {"common": "Timor-Leste", "official": "Democratic Republic of Timor-Leste", "nativeName": {"por": {"official": "República Democrática de Timor-Leste", "common": "Timor-Leste"}, "tet": {"official": "Repúblika Demokrátika Timór-Leste", "common": "Timór-Leste"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["IDN"], "flag": "\uD83C\uDDF9\uD83C\uDDF1", "maps": {"googleMaps": "https://goo.gl/maps/sFqBC9zjgUXPR1iTA", "openStreetMaps": "https://www.openstreetmap.org/relation/305142"}}, {"name": {"common": "Panama", "official": "Republic of Panama", "nativeName": {"spa": {"official": "República de Panamá", "common": "Panamá"}}}, "currencies": {"PAB": {"name": "Panamanian balboa", "symbol": "B/."}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["COL", "CRI"], "flag": "\uD83C\uDDF5\uD83C\uDDE6", "maps": {"googleMaps": "https://goo.gl/maps/sEN7sKqeawa5oPNLA", "openStreetMaps": "https://www.openstreetmap.org/relation/287668"}}, {"name": {"common": "Bahamas", "official": "Commonwealth of the Bahamas", "nativeName": {"eng": {"official": "Commonwealth of the Bahamas", "common": "Bahamas"}}}, "currencies": {"BSD": {"name": "Bahamian dollar", "symbol": "$"}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE7\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/1YzRs1BZrG8p8pmVA", "openStreetMaps": "https://www.openstreetmap.org/relation/547469"}}, {"name": {"common": "Northern Mariana Islands", "official": "Commonwealth of the Northern Mariana Islands", "nativeName": {"cal": {"official": "Commonwealth of the Northern Mariana Islands", "common": "Northern Mariana Islands"}, "cha": {"official": "Sankattan Siha Na Islas Mariånas", "common": "Na Islas Mariånas"}, "eng": {"official": "Commonwealth of the Northern Mariana Islands", "common": "Northern Mariana Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF2\uD83C\uDDF5", "maps": {"googleMaps": "https://goo.gl/maps/cpZ67knoRAcfu1417", "openStreetMaps": "https://www.openstreetmap.org/relation/306004"}}, {"name": {"common": "British Indian Ocean Territory", "official": "British Indian Ocean Territory", "nativeName": {"eng": {"official": "British Indian Ocean Territory", "common": "British Indian Ocean Territory"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEE\uD83C\uDDF4", "maps": {"googleMaps": "https://goo.gl/maps/bheNucgekVEYozoi6", "openStreetMaps": "https://www.openstreetmap.org/relation/1993867"}}, {"name": {"common": "Marshall Islands", "official": "Republic of the Marshall Islands", "nativeName": {"eng": {"official": "Republic of the Marshall Islands", "common": "Marshall Islands"}, "mah": {"official": "Republic of the Marshall Islands", "common": "M̧ajeļ"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF2\uD83C\uDDED", "maps": {"googleMaps": "https://goo.gl/maps/A4xLi1XvcX88gi3W8", "openStreetMaps": "https://www.openstreetmap.org/relation/571771"}}, {"name": {"common": "American Samoa", "official": "American Samoa", "nativeName": {"eng": {"official": "American Samoa", "common": "American Samoa"}, "smo": {"official": "Sāmoa Amelika", "common": "Sāmoa Amelika"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE6\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/Re9ePMjwP1sFCBFA6", "openStreetMaps": "https://www.openstreetmap.org/relation/2177187"}}, {"name": {"common": "Palau", "official": "Republic of Palau", "nativeName": {"eng": {"official": "Republic of Palau", "common": "Palau"}, "pau": {"official": "Beluu er a Belau", "common": "Belau"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF5\uD83C\uDDFC", "maps": {"googleMaps": "https://goo.gl/maps/MVasQBbUkQP7qQDR9", "openStreetMaps": "https://www.openstreetmap.org/relation/571805"}}, {"name": {"common": "United States", "official": "United States of America", "nativeName": {"eng": {"official": "United States of America", "common": "United States"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["CAN", "MEX"], "flag": "\uD83C\uDDFA\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/e8M246zY4BSjkjAv6", "openStreetMaps": "https://www.openstreetmap.org/relation/148838#map=2/20.6/-85.8"}}, {"name": {"common": "El Salvador", "official": "Republic of El Salvador", "nativeName": {"spa": {"official": "República de El Salvador", "common": "El Salvador"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["GTM", "HND"], "flag": "\uD83C\uDDF8\uD83C\uDDFB", "maps": {"googleMaps": "https://goo.gl/maps/cZnCEi5sEMQtKKcB7", "openStreetMaps": "https://www.openstreetmap.org/relation/1520612"}}, {"name": {"common": "Micronesia", "official": "Federated States of Micronesia", "nativeName": {"eng": {"official": "Federated States of Micronesia", "common": "Micronesia"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEB\uD83C\uDDF2", "maps": {"googleMaps": "https://goo.gl/maps/LLcnofC5LxZsJXTo8", "openStreetMaps": "https://www.openstreetmap.org/relation/571802"}}]'));
            expect(result).to.equal(expected);
        });

        it('When only provided with currency, the result should not depend on case of the string', async () => {
            const result = JSON.stringify(await guideService.getCountryInfo(undefined,'usd'));
            const expected = JSON.stringify(JSON.parse('[{"name": {"common": "United States Minor Outlying Islands", "official": "United States Minor Outlying Islands", "nativeName": {"eng": {"official": "United States Minor Outlying Islands", "common": "United States Minor Outlying Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFA\uD83C\uDDF2", "maps": {"googleMaps": "https://goo.gl/maps/hZKnrzgeK69dDyPF8", "openStreetMaps": "https://www.openstreetmap.org/relation/6430384"}}, {"name": {"common": "Turks and Caicos Islands", "official": "Turks and Caicos Islands", "nativeName": {"eng": {"official": "Turks and Caicos Islands", "common": "Turks and Caicos Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF9\uD83C\uDDE8", "maps": {"googleMaps": "https://goo.gl/maps/R8VUDQfwZiFtvmyn8", "openStreetMaps": "https://www.openstreetmap.org/relation/547479"}}, {"name": {"common": "Puerto Rico", "official": "Commonwealth of Puerto Rico", "nativeName": {"eng": {"official": "Commonwealth of Puerto Rico", "common": "Puerto Rico"}, "spa": {"official": "Estado Libre Asociado de Puerto Rico", "common": "Puerto Rico"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF5\uD83C\uDDF7", "maps": {"googleMaps": "https://goo.gl/maps/sygfDbtwn389wu8x5", "openStreetMaps": "https://www.openstreetmap.org/relation/4422604"}}, {"name": {"common": "British Virgin Islands", "official": "Virgin Islands", "nativeName": {"eng": {"official": "Virgin Islands", "common": "British Virgin Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFB\uD83C\uDDEC", "maps": {"googleMaps": "https://goo.gl/maps/49C9cSesNVAR9DQk8", "openStreetMaps": "https://www.openstreetmap.org/relation/285454"}}, {"name": {"common": "Ecuador", "official": "Republic of Ecuador", "nativeName": {"spa": {"official": "República del Ecuador", "common": "Ecuador"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["COL", "PER"], "flag": "\uD83C\uDDEA\uD83C\uDDE8", "maps": {"googleMaps": "https://goo.gl/maps/TbX8hUW4gcbRPZiK7", "openStreetMaps": "https://www.openstreetmap.org/relation/108089"}}, {"name": {"common": "Caribbean Netherlands", "official": "Bonaire, Sint Eustatius and Saba", "nativeName": {"nld": {"official": "Bonaire, Sint Eustatius en Saba", "common": "Caribisch Nederland"}, "pap": {"official": "Boneiru, Sint Eustatius y Saba", "common": "Boneiru, Sint Eustatius y Saba"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE7\uD83C\uDDF6", "maps": {"googleMaps": "https://goo.gl/maps/4XVes1P6uEDTz77WA", "openStreetMaps": "https://www.openstreetmap.org/relation/1216720"}}, {"name": {"common": "Cambodia", "official": "Kingdom of Cambodia", "nativeName": {"khm": {"official": "ព្រះរាជាណាចក្រកម្ពុជា", "common": "Kâmpŭchéa"}}}, "currencies": {"KHR": {"name": "Cambodian riel", "symbol": "៛"}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["LAO", "THA", "VNM"], "flag": "\uD83C\uDDF0\uD83C\uDDED", "maps": {"googleMaps": "https://goo.gl/maps/nztQtFSrUXZymJaW8", "openStreetMaps": "https://www.openstreetmap.org/relation/49898"}}, {"name": {"common": "Guam", "official": "Guam", "nativeName": {"cha": {"official": "Guåhån", "common": "Guåhån"}, "eng": {"official": "Guam", "common": "Guam"}, "spa": {"official": "Guam", "common": "Guam"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEC\uD83C\uDDFA", "maps": {"googleMaps": "https://goo.gl/maps/Xfnq2i279b18cH3C9", "openStreetMaps": "https://www.openstreetmap.org/relation/306001"}}, {"name": {"common": "United States Virgin Islands", "official": "Virgin Islands of the United States", "nativeName": {"eng": {"official": "Virgin Islands of the United States", "common": "United States Virgin Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFB\uD83C\uDDEE", "maps": {"googleMaps": "https://goo.gl/maps/mBfreywj8dor6q4m9", "openStreetMaps": "openstreetmap.org/relation/286898"}}, {"name": {"common": "Timor-Leste", "official": "Democratic Republic of Timor-Leste", "nativeName": {"por": {"official": "República Democrática de Timor-Leste", "common": "Timor-Leste"}, "tet": {"official": "Repúblika Demokrátika Timór-Leste", "common": "Timór-Leste"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["IDN"], "flag": "\uD83C\uDDF9\uD83C\uDDF1", "maps": {"googleMaps": "https://goo.gl/maps/sFqBC9zjgUXPR1iTA", "openStreetMaps": "https://www.openstreetmap.org/relation/305142"}}, {"name": {"common": "Panama", "official": "Republic of Panama", "nativeName": {"spa": {"official": "República de Panamá", "common": "Panamá"}}}, "currencies": {"PAB": {"name": "Panamanian balboa", "symbol": "B/."}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["COL", "CRI"], "flag": "\uD83C\uDDF5\uD83C\uDDE6", "maps": {"googleMaps": "https://goo.gl/maps/sEN7sKqeawa5oPNLA", "openStreetMaps": "https://www.openstreetmap.org/relation/287668"}}, {"name": {"common": "Bahamas", "official": "Commonwealth of the Bahamas", "nativeName": {"eng": {"official": "Commonwealth of the Bahamas", "common": "Bahamas"}}}, "currencies": {"BSD": {"name": "Bahamian dollar", "symbol": "$"}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE7\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/1YzRs1BZrG8p8pmVA", "openStreetMaps": "https://www.openstreetmap.org/relation/547469"}}, {"name": {"common": "Northern Mariana Islands", "official": "Commonwealth of the Northern Mariana Islands", "nativeName": {"cal": {"official": "Commonwealth of the Northern Mariana Islands", "common": "Northern Mariana Islands"}, "cha": {"official": "Sankattan Siha Na Islas Mariånas", "common": "Na Islas Mariånas"}, "eng": {"official": "Commonwealth of the Northern Mariana Islands", "common": "Northern Mariana Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF2\uD83C\uDDF5", "maps": {"googleMaps": "https://goo.gl/maps/cpZ67knoRAcfu1417", "openStreetMaps": "https://www.openstreetmap.org/relation/306004"}}, {"name": {"common": "British Indian Ocean Territory", "official": "British Indian Ocean Territory", "nativeName": {"eng": {"official": "British Indian Ocean Territory", "common": "British Indian Ocean Territory"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEE\uD83C\uDDF4", "maps": {"googleMaps": "https://goo.gl/maps/bheNucgekVEYozoi6", "openStreetMaps": "https://www.openstreetmap.org/relation/1993867"}}, {"name": {"common": "Marshall Islands", "official": "Republic of the Marshall Islands", "nativeName": {"eng": {"official": "Republic of the Marshall Islands", "common": "Marshall Islands"}, "mah": {"official": "Republic of the Marshall Islands", "common": "M̧ajeļ"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF2\uD83C\uDDED", "maps": {"googleMaps": "https://goo.gl/maps/A4xLi1XvcX88gi3W8", "openStreetMaps": "https://www.openstreetmap.org/relation/571771"}}, {"name": {"common": "American Samoa", "official": "American Samoa", "nativeName": {"eng": {"official": "American Samoa", "common": "American Samoa"}, "smo": {"official": "Sāmoa Amelika", "common": "Sāmoa Amelika"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE6\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/Re9ePMjwP1sFCBFA6", "openStreetMaps": "https://www.openstreetmap.org/relation/2177187"}}, {"name": {"common": "Palau", "official": "Republic of Palau", "nativeName": {"eng": {"official": "Republic of Palau", "common": "Palau"}, "pau": {"official": "Beluu er a Belau", "common": "Belau"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF5\uD83C\uDDFC", "maps": {"googleMaps": "https://goo.gl/maps/MVasQBbUkQP7qQDR9", "openStreetMaps": "https://www.openstreetmap.org/relation/571805"}}, {"name": {"common": "United States", "official": "United States of America", "nativeName": {"eng": {"official": "United States of America", "common": "United States"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["CAN", "MEX"], "flag": "\uD83C\uDDFA\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/e8M246zY4BSjkjAv6", "openStreetMaps": "https://www.openstreetmap.org/relation/148838#map=2/20.6/-85.8"}}, {"name": {"common": "El Salvador", "official": "Republic of El Salvador", "nativeName": {"spa": {"official": "República de El Salvador", "common": "El Salvador"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["GTM", "HND"], "flag": "\uD83C\uDDF8\uD83C\uDDFB", "maps": {"googleMaps": "https://goo.gl/maps/cZnCEi5sEMQtKKcB7", "openStreetMaps": "https://www.openstreetmap.org/relation/1520612"}}, {"name": {"common": "Micronesia", "official": "Federated States of Micronesia", "nativeName": {"eng": {"official": "Federated States of Micronesia", "common": "Micronesia"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEB\uD83C\uDDF2", "maps": {"googleMaps": "https://goo.gl/maps/LLcnofC5LxZsJXTo8", "openStreetMaps": "https://www.openstreetmap.org/relation/571802"}}]'));
            expect(result).to.equal(expected);
        });

        it('If neither country nor currency were found, it should return an error',  async () => {
            await expect(guideService.getCountryInfo('book', 'cru')).to.be.rejectedWith(Error);
        });

        it('If provided country could not be found and currency was provided, it should return result based on currency', async () => {
            const result = JSON.stringify(await guideService.getCountryInfo('book','USD'));
            const expected = JSON.stringify(JSON.parse('[{"name": {"common": "United States Minor Outlying Islands", "official": "United States Minor Outlying Islands", "nativeName": {"eng": {"official": "United States Minor Outlying Islands", "common": "United States Minor Outlying Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFA\uD83C\uDDF2", "maps": {"googleMaps": "https://goo.gl/maps/hZKnrzgeK69dDyPF8", "openStreetMaps": "https://www.openstreetmap.org/relation/6430384"}}, {"name": {"common": "Turks and Caicos Islands", "official": "Turks and Caicos Islands", "nativeName": {"eng": {"official": "Turks and Caicos Islands", "common": "Turks and Caicos Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF9\uD83C\uDDE8", "maps": {"googleMaps": "https://goo.gl/maps/R8VUDQfwZiFtvmyn8", "openStreetMaps": "https://www.openstreetmap.org/relation/547479"}}, {"name": {"common": "Puerto Rico", "official": "Commonwealth of Puerto Rico", "nativeName": {"eng": {"official": "Commonwealth of Puerto Rico", "common": "Puerto Rico"}, "spa": {"official": "Estado Libre Asociado de Puerto Rico", "common": "Puerto Rico"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF5\uD83C\uDDF7", "maps": {"googleMaps": "https://goo.gl/maps/sygfDbtwn389wu8x5", "openStreetMaps": "https://www.openstreetmap.org/relation/4422604"}}, {"name": {"common": "British Virgin Islands", "official": "Virgin Islands", "nativeName": {"eng": {"official": "Virgin Islands", "common": "British Virgin Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFB\uD83C\uDDEC", "maps": {"googleMaps": "https://goo.gl/maps/49C9cSesNVAR9DQk8", "openStreetMaps": "https://www.openstreetmap.org/relation/285454"}}, {"name": {"common": "Ecuador", "official": "Republic of Ecuador", "nativeName": {"spa": {"official": "República del Ecuador", "common": "Ecuador"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["COL", "PER"], "flag": "\uD83C\uDDEA\uD83C\uDDE8", "maps": {"googleMaps": "https://goo.gl/maps/TbX8hUW4gcbRPZiK7", "openStreetMaps": "https://www.openstreetmap.org/relation/108089"}}, {"name": {"common": "Caribbean Netherlands", "official": "Bonaire, Sint Eustatius and Saba", "nativeName": {"nld": {"official": "Bonaire, Sint Eustatius en Saba", "common": "Caribisch Nederland"}, "pap": {"official": "Boneiru, Sint Eustatius y Saba", "common": "Boneiru, Sint Eustatius y Saba"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE7\uD83C\uDDF6", "maps": {"googleMaps": "https://goo.gl/maps/4XVes1P6uEDTz77WA", "openStreetMaps": "https://www.openstreetmap.org/relation/1216720"}}, {"name": {"common": "Cambodia", "official": "Kingdom of Cambodia", "nativeName": {"khm": {"official": "ព្រះរាជាណាចក្រកម្ពុជា", "common": "Kâmpŭchéa"}}}, "currencies": {"KHR": {"name": "Cambodian riel", "symbol": "៛"}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["LAO", "THA", "VNM"], "flag": "\uD83C\uDDF0\uD83C\uDDED", "maps": {"googleMaps": "https://goo.gl/maps/nztQtFSrUXZymJaW8", "openStreetMaps": "https://www.openstreetmap.org/relation/49898"}}, {"name": {"common": "Guam", "official": "Guam", "nativeName": {"cha": {"official": "Guåhån", "common": "Guåhån"}, "eng": {"official": "Guam", "common": "Guam"}, "spa": {"official": "Guam", "common": "Guam"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEC\uD83C\uDDFA", "maps": {"googleMaps": "https://goo.gl/maps/Xfnq2i279b18cH3C9", "openStreetMaps": "https://www.openstreetmap.org/relation/306001"}}, {"name": {"common": "United States Virgin Islands", "official": "Virgin Islands of the United States", "nativeName": {"eng": {"official": "Virgin Islands of the United States", "common": "United States Virgin Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDFB\uD83C\uDDEE", "maps": {"googleMaps": "https://goo.gl/maps/mBfreywj8dor6q4m9", "openStreetMaps": "openstreetmap.org/relation/286898"}}, {"name": {"common": "Timor-Leste", "official": "Democratic Republic of Timor-Leste", "nativeName": {"por": {"official": "República Democrática de Timor-Leste", "common": "Timor-Leste"}, "tet": {"official": "Repúblika Demokrátika Timór-Leste", "common": "Timór-Leste"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["IDN"], "flag": "\uD83C\uDDF9\uD83C\uDDF1", "maps": {"googleMaps": "https://goo.gl/maps/sFqBC9zjgUXPR1iTA", "openStreetMaps": "https://www.openstreetmap.org/relation/305142"}}, {"name": {"common": "Panama", "official": "Republic of Panama", "nativeName": {"spa": {"official": "República de Panamá", "common": "Panamá"}}}, "currencies": {"PAB": {"name": "Panamanian balboa", "symbol": "B/."}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["COL", "CRI"], "flag": "\uD83C\uDDF5\uD83C\uDDE6", "maps": {"googleMaps": "https://goo.gl/maps/sEN7sKqeawa5oPNLA", "openStreetMaps": "https://www.openstreetmap.org/relation/287668"}}, {"name": {"common": "Bahamas", "official": "Commonwealth of the Bahamas", "nativeName": {"eng": {"official": "Commonwealth of the Bahamas", "common": "Bahamas"}}}, "currencies": {"BSD": {"name": "Bahamian dollar", "symbol": "$"}, "USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE7\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/1YzRs1BZrG8p8pmVA", "openStreetMaps": "https://www.openstreetmap.org/relation/547469"}}, {"name": {"common": "Northern Mariana Islands", "official": "Commonwealth of the Northern Mariana Islands", "nativeName": {"cal": {"official": "Commonwealth of the Northern Mariana Islands", "common": "Northern Mariana Islands"}, "cha": {"official": "Sankattan Siha Na Islas Mariånas", "common": "Na Islas Mariånas"}, "eng": {"official": "Commonwealth of the Northern Mariana Islands", "common": "Northern Mariana Islands"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF2\uD83C\uDDF5", "maps": {"googleMaps": "https://goo.gl/maps/cpZ67knoRAcfu1417", "openStreetMaps": "https://www.openstreetmap.org/relation/306004"}}, {"name": {"common": "British Indian Ocean Territory", "official": "British Indian Ocean Territory", "nativeName": {"eng": {"official": "British Indian Ocean Territory", "common": "British Indian Ocean Territory"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEE\uD83C\uDDF4", "maps": {"googleMaps": "https://goo.gl/maps/bheNucgekVEYozoi6", "openStreetMaps": "https://www.openstreetmap.org/relation/1993867"}}, {"name": {"common": "Marshall Islands", "official": "Republic of the Marshall Islands", "nativeName": {"eng": {"official": "Republic of the Marshall Islands", "common": "Marshall Islands"}, "mah": {"official": "Republic of the Marshall Islands", "common": "M̧ajeļ"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF2\uD83C\uDDED", "maps": {"googleMaps": "https://goo.gl/maps/A4xLi1XvcX88gi3W8", "openStreetMaps": "https://www.openstreetmap.org/relation/571771"}}, {"name": {"common": "American Samoa", "official": "American Samoa", "nativeName": {"eng": {"official": "American Samoa", "common": "American Samoa"}, "smo": {"official": "Sāmoa Amelika", "common": "Sāmoa Amelika"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDE6\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/Re9ePMjwP1sFCBFA6", "openStreetMaps": "https://www.openstreetmap.org/relation/2177187"}}, {"name": {"common": "Palau", "official": "Republic of Palau", "nativeName": {"eng": {"official": "Republic of Palau", "common": "Palau"}, "pau": {"official": "Beluu er a Belau", "common": "Belau"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDF5\uD83C\uDDFC", "maps": {"googleMaps": "https://goo.gl/maps/MVasQBbUkQP7qQDR9", "openStreetMaps": "https://www.openstreetmap.org/relation/571805"}}, {"name": {"common": "United States", "official": "United States of America", "nativeName": {"eng": {"official": "United States of America", "common": "United States"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["CAN", "MEX"], "flag": "\uD83C\uDDFA\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/e8M246zY4BSjkjAv6", "openStreetMaps": "https://www.openstreetmap.org/relation/148838#map=2/20.6/-85.8"}}, {"name": {"common": "El Salvador", "official": "Republic of El Salvador", "nativeName": {"spa": {"official": "República de El Salvador", "common": "El Salvador"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["GTM", "HND"], "flag": "\uD83C\uDDF8\uD83C\uDDFB", "maps": {"googleMaps": "https://goo.gl/maps/cZnCEi5sEMQtKKcB7", "openStreetMaps": "https://www.openstreetmap.org/relation/1520612"}}, {"name": {"common": "Micronesia", "official": "Federated States of Micronesia", "nativeName": {"eng": {"official": "Federated States of Micronesia", "common": "Micronesia"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": [], "flag": "\uD83C\uDDEB\uD83C\uDDF2", "maps": {"googleMaps": "https://goo.gl/maps/LLcnofC5LxZsJXTo8", "openStreetMaps": "https://www.openstreetmap.org/relation/571802"}}]'));
            expect(result).to.equal(expected);
        });

        it('If country was not found and currency was not provided, it should return an error',  async () => {
            await expect(guideService.getCountryInfo('book', 'cru')).to.be.rejectedWith(Error);
        });
    });

    describe('Test getCurrencyInfo', () => {
        let sampleCachedResponse;
        let findOneStub;
        let countryInfo;
        const currencies = {"AUD": 1.5292702249, "BGN": 1.797720246, "BRL": 4.9800906282, "CAD": 1.3500102507, "CHF": 0.879950112, "CNY": 7.1967313059, "CZK": 23.3561445773, "DKK": 6.8690712466, "EUR": 0.9214401668, "GBP": 0.7882301417, "HKD": 7.8218014735, "HRK": 6.6727809197, "HUF": 358.7187123958, "IDR": 15608.20354137, "ILS": 3.6343104276, "INR": 82.8275664676, "ISK": 137.7658464635, "JPY": 150.5194687045, "KRW": 1329.6156534884, "MXN": 17.0845631758, "MYR": 4.7749605174, "NOK": 10.5088015174, "NZD": 1.6217002221, "PHP": 55.9549494486, "PLN": 3.968870522, "RON": 4.5797208181, "RUB": 91.8528318894, "SEK": 10.2776211318, "SGD": 1.3430202438, "THB": 35.9209757009, "TRY": 31.1518562242, "USD": 1, "ZAR": 19.2946125531};

        beforeEach(() => {
            sampleCachedResponse = {'response': {"data": {"AUD": 1.5292702249, "BGN": 1.797720246, "BRL": 4.9800906282, "CAD": 1.3500102507, "CHF": 0.879950112, "CNY": 7.1967313059, "CZK": 23.3561445773, "DKK": 6.8690712466, "EUR": 0.9214401668, "GBP": 0.7882301417, "HKD": 7.8218014735, "HRK": 6.6727809197, "HUF": 358.7187123958, "IDR": 15608.20354137, "ILS": 3.6343104276, "INR": 82.8275664676, "ISK": 137.7658464635, "JPY": 150.5194687045, "KRW": 1329.6156534884, "MXN": 17.0845631758, "MYR": 4.7749605174, "NOK": 10.5088015174, "NZD": 1.6217002221, "PHP": 55.9549494486, "PLN": 3.968870522, "RON": 4.5797208181, "RUB": 91.8528318894, "SEK": 10.2776211318, "SGD": 1.3430202438, "THB": 35.9209757009, "TRY": 31.1518562242, "USD": 1, "ZAR": 19.2946125531}}};
            countryInfo = JSON.parse('[{"name": {"common": "United States", "official": "United States of America", "nativeName": {"eng": {"official": "United States of America", "common": "United States"}}}, "currencies": {"USD": {"name": "United States dollar", "symbol": "$"}}, "borders": ["CAN", "MEX"], "flag": "\uD83C\uDDFA\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/e8M246zY4BSjkjAv6", "openStreetMaps": "https://www.openstreetmap.org/relation/148838#map=2/20.6/-85.8"}}]');

            findOneStub = stub(Model, 'findOne').resolves(sampleCachedResponse);
        });

        it('When provided with both currencies and money, it should return translated money', async () => {
            const result = await guideService.getCurrencyInfo('EUR', 500, countryInfo);
            const expected = 500*currencies['USD']/currencies['EUR'];
            expect(result).to.equal(expected);
        });

        it('When provided with both currencies and money, the case of currency should not matter', async () => {
            const result = await guideService.getCurrencyInfo('eur', 500, countryInfo);
            const expected = 500*currencies['USD']/currencies['EUR'];
            expect(result).to.equal(expected);
        });

        it('If provided currency could not be found, it should return false', async () => {
            const result = await guideService.getCurrencyInfo('YEN', 500, countryInfo);
            const expected = false;
            expect(result).to.equal(expected);
        });

        it('If currency from countryInfo could not be found, it should return false', async () => {
            countryInfo = JSON.parse('[{"name": {"common": "United States", "official": "United States of America", "nativeName": {"eng": {"official": "United States of America", "common": "United States"}}}, "currencies": {"CUR": {"name": "United States dollar", "symbol": "$"}}, "borders": ["CAN", "MEX"], "flag": "\uD83C\uDDFA\uD83C\uDDF8", "maps": {"googleMaps": "https://goo.gl/maps/e8M246zY4BSjkjAv6", "openStreetMaps": "https://www.openstreetmap.org/relation/148838#map=2/20.6/-85.8"}}]');
            const result = await guideService.getCurrencyInfo('EUR', 500, countryInfo);
            const expected = false;
            expect(result).to.equal(expected);
        });
    });
});